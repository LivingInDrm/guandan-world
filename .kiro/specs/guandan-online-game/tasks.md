# 掼蛋在线对战游戏实现计划

- [x] 1. 创建完全独立的SDK游戏引擎
  - 基于现有牌规则SDK，创建完全自治的游戏引擎
  - 实现事件驱动的游戏状态管理系统
  - 创建GameEngine、Match、Deal、Trick等完整的游戏逻辑层
  - 确保SDK完全独立，不依赖任何外部服务
  - _需求: 需求4, 需求5, 需求6, 需求7_

- [x] 1.1 实现GameEngine核心架构和事件系统
  - 在sdk/game_engine.go中创建GameEngine主结构体
  - 实现完全独立的事件系统（GameEvent、GameEventType、事件处理器）
  - 实现GameEngineInterface接口，定义所有对外方法
  - 实现NewGameEngine工厂方法和基础生命周期管理
  - 编写GameEngine核心架构的单元测试
  - _需求: 需求4, 需求5_

- [x] 1.2 实现Match和Deal完全独立的管理系统
  - 在sdk/match.go中创建Match结构体和完整的比赛管理逻辑
  - 在sdk/deal.go中创建Deal结构体和局管理逻辑
  - 实现Match和Deal的完整生命周期，包括创建、进行、结束
  - 实现队伍等级管理和升级逻辑
  - 编写Match和Deal管理的单元测试
  - _需求: 需求5, 需求8, 需求9_

- [x] 1.3 实现Trick完全独立的轮次管理系统
  - 在sdk/trick.go中创建Trick和Play结构体
  - 实现完整的出牌轮次控制，包括轮次开始、玩家出牌、轮次结束
  - 实现Trick获胜者判定和下一轮次的自动开始
  - 集成现有的牌型比较逻辑（FromCardList）
  - 编写Trick轮次管理的单元测试
  - _需求: 需求6, 需求7_

- [x] 2. 实现SDK内完全独立的发牌和上贡系统
  - 在SDK内实现完整的发牌逻辑，包括牌堆创建、洗牌、发牌
  - 实现完全自治的上贡系统，包括上贡判定、选择、还贡
  - 确保发牌和上贡逻辑完全在SDK内部完成，不依赖外部输入
  - _需求: 需求5_

- [x] 2.1 实现SDK内完全独立的发牌系统
  - 在sdk/dealer.go中实现完整的牌堆管理（108张牌创建、洗牌）
  - 实现自动发牌逻辑，每人27张牌，剩余3张底牌
  - 实现手牌自动排序和整理功能
  - 实现发牌完成后的事件触发（EventCardsDealt）
  - 编写发牌系统的单元测试
  - _需求: 需求5_

- [x] 2.2 实现SDK内完全独立的上贡系统
  - 在sdk/tribute.go中创建完整的TributePhase管理系统
  - 实现根据上局DealResult自动判定上贡和免贡的逻辑
  - 实现双下情况的贡池自动创建和选择超时管理
  - 实现自动还贡逻辑和上贡阶段完成的事件触发
  - 编写上贡系统的单元测试
  - _需求: 需求5_

- [x] 3. 实现SDK内完全独立的出牌验证和流程控制
  - 在SDK内实现完整的出牌验证系统，集成现有牌型识别
  - 实现完全自治的游戏流程控制，包括轮次管理、状态转换
  - 确保所有游戏规则验证都在SDK内部完成
  - _需求: 需求6, 需求7_

- [x] 3.1 实现SDK内完全独立的出牌验证系统
  - 在sdk/validator.go中创建出牌验证器
  - 集成现有的FromCardList牌型识别，实现牌型合法性验证
  - 实现轮次验证（是否轮到该玩家）和牌组比较验证
  - 实现Pass操作的合法性验证
  - 编写出牌验证系统的单元测试
  - _需求: 需求7_

- [x] 3.2 实现SDK内完全独立的游戏流程控制
  - 在GameEngine中实现完整的状态机，管理游戏各个阶段的转换
  - 实现Trick的自动生命周期管理（开始->进行->结束->新Trick）
  - 实现Deal结束判定和Match结束判定的自动化
  - 实现所有状态变化的事件自动触发
  - 编写游戏流程控制的单元测试
  - _需求: 需求6, 需求7_

- [x] 4. 实现SDK内完全独立的结算和Match管理
  - 在SDK内实现完整的Deal结算系统，包括排名、升级计算
  - 实现完全自治的Match管理，包括多局游戏和最终胜负判定
  - 确保所有结算逻辑都在SDK内部自动完成
  - _需求: 需求8, 需求9_

- [x] 4.1 实现SDK内完全独立的Deal结算系统
  - 在sdk/result.go中创建完整的结算系统
  - 实现Deal结束时的自动排名计算和胜利类型判定
  - 实现队伍升级的自动计算（+1/+2/+3）
  - 实现Deal统计信息的自动收集和EventDealEnded事件触发
  - 编写Deal结算系统的单元测试
  - _需求: 需求8_

- [x] 4.2 实现SDK内完全独立的Match管理系统
  - 在Match中实现完整的多局游戏管理
  - 实现达到A级的自动Match结束判定
  - 实现Match统计信息的自动收集和EventMatchEnded事件触发
  - 实现新Deal的自动开始逻辑
  - 编写Match管理系统的单元测试
  - _需求: 需求9_

- [ ] 5. 实现SDK内完全独立的断线托管和超时处理
  - 在SDK内实现完整的玩家状态管理，包括在线、离线、托管状态
  - 实现完全自治的超时处理和托管逻辑
  - 确保断线和超时处理完全在SDK内部自动完成
  - _需求: 需求10, 需求11_

- [ ] 5.1 实现SDK内完全独立的断线托管系统
  - 在sdk/player_manager.go中实现玩家状态管理
  - 实现HandlePlayerDisconnect和HandlePlayerReconnect的完全自治逻辑
  - 实现托管状态下的智能自动出牌策略
  - 实现断线重连的状态恢复和事件触发
  - 编写断线托管系统的单元测试
  - _需求: 需求10_

- [ ] 5.2 实现SDK内完全独立的超时处理系统
  - 在sdk/timeout_manager.go中实现超时管理器
  - 实现ProcessTimeouts方法的完全自治逻辑
  - 实现操作超时的自动Pass和连续超时转托管
  - 实现超时事件的自动触发（EventPlayerTimeout）
  - 编写超时处理系统的单元测试
  - _需求: 需求11_

- [ ] 6. 实现后端用户认证系统
  - 创建用户注册和登录API
  - 实现JWT token生成和验证
  - 实现用户会话管理
  - _需求: 需求1_

- [ ] 6.1 创建用户认证服务
  - 在backend/auth/service.go中创建AuthService结构体
  - 实现用户注册逻辑，包括用户名唯一性验证
  - 实现用户登录验证和JWT token生成
  - 实现用户登出和token失效处理
  - 编写认证服务的单元测试
  - _需求: 需求1_

- [ ] 6.2 创建认证API端点
  - 在backend/handlers/auth.go中实现注册、登录、登出的HTTP处理器
  - 实现JWT中间件用于保护需要认证的API
  - 实现错误处理和响应格式标准化
  - 编写API端点的集成测试
  - _需求: 需求1_

- [ ] 7. 实现房间管理系统
  - 创建房间创建、加入、离开API
  - 实现房间列表查询和分页
  - 实现房间状态管理和玩家座位分配
  - _需求: 需求2, 需求3_

- [ ] 7.1 创建房间管理服务
  - 在backend/room/service.go中创建RoomService结构体
  - 实现房间创建、玩家加入和离开逻辑
  - 实现房间列表查询，支持状态过滤和分页
  - 实现房主权限管理和房间自动关闭
  - 编写房间服务的单元测试
  - _需求: 需求2, 需求3_

- [ ] 7.2 创建房间管理API
  - 在backend/handlers/room.go中实现房间相关的HTTP处理器
  - 实现GET /api/rooms房间列表查询，支持分页参数
  - 实现POST /api/rooms房间创建和POST /api/rooms/:id/join加入房间
  - 实现房间状态验证和权限检查
  - 编写房间API的集成测试
  - _需求: 需求2, 需求3_

- [ ] 8. 实现WebSocket连接管理
  - 创建WebSocket连接处理和消息路由
  - 实现房间内消息广播机制
  - 实现连接断开和重连处理
  - _需求: 需求4, 需求10_

- [ ] 8.1 创建WebSocket管理器
  - 在backend/websocket/manager.go中创建WSManager结构体
  - 实现WebSocket连接的注册、注销和消息路由
  - 实现房间级别的消息广播机制
  - 实现连接心跳检测和自动清理
  - 编写WebSocket管理器的单元测试
  - _需求: 需求4, 需求10_

- [ ] 8.2 实现WebSocket消息处理
  - 在backend/websocket/handlers.go中实现各种消息类型的处理器
  - 实现join_room、start_game、play_cards、pass等消息处理
  - 实现消息验证和错误处理
  - 实现WebSocket认证和权限验证
  - 编写消息处理的集成测试
  - _需求: 需求4, 需求7_

- [ ] 9. 实现纯协调的游戏服务（不含游戏逻辑）
  - 创建完全基于SDK事件系统的游戏协调服务
  - 实现SDK事件到WebSocket消息的转换
  - 确保服务器层不包含任何游戏规则逻辑
  - _需求: 需求4, 需求6, 需求7_

- [ ] 9.1 创建基于SDK事件系统的游戏协调服务
  - 在backend/game/service.go中创建纯协调的GameService
  - 实现SDK GameEngine的创建和事件处理器注册
  - 实现所有玩家操作的直接委托给SDK（不做任何验证或处理）
  - 实现SDK事件的接收和WebSocket消息转换
  - 编写游戏协调服务的单元测试
  - _需求: 需求4, 需求6, 需求7_

- [ ] 9.2 实现基于SDK事件的状态同步
  - 实现SDK事件的实时监听和广播机制
  - 实现基于SDK GetPlayerView的玩家视角状态过滤
  - 实现ProcessTimeouts的定时调用和超时事件处理
  - 编写事件驱动状态同步的集成测试
  - _需求: 需求6, 需求8_

- [ ] 10. 实现前端用户认证界面
  - 创建登录和注册页面组件
  - 实现用户状态管理和路由保护
  - 实现自动登录和token刷新
  - _需求: 需求1_

- [ ] 10.1 创建认证页面组件
  - 在frontend/src/components/auth/中创建LoginForm和RegisterForm组件
  - 实现表单验证和提交逻辑
  - 实现错误提示和加载状态显示
  - 实现注册成功后自动登录跳转
  - 编写认证组件的单元测试
  - _需求: 需求1_

- [ ] 10.2 实现用户状态管理
  - 在frontend/src/store/中创建用户状态管理
  - 实现JWT token的本地存储和自动加载
  - 实现路由保护，未登录用户重定向到登录页
  - 实现用户信息的全局状态管理
  - 编写状态管理的单元测试
  - _需求: 需求1_

- [ ] 11. 实现房间大厅界面
  - 创建房间列表和房间卡片组件
  - 实现房间创建和加入功能
  - 实现房间列表的分页加载
  - _需求: 需求2_

- [ ] 11.1 创建房间大厅组件
  - 在frontend/src/components/lobby/中创建RoomLobby和RoomList组件
  - 实现房间列表的获取和显示，支持状态过滤
  - 实现房间卡片的信息展示（人数、状态、玩家名单）
  - 实现创建新房间的弹窗和表单
  - 编写房间大厅组件的单元测试
  - _需求: 需求2_

- [ ] 11.2 实现房间交互功能
  - 实现房间加入按钮的状态控制（可点击/置灰）
  - 实现房间列表的分页加载，每页12个房间
  - 实现房间状态的实时更新
  - 编写房间交互的集成测试
  - _需求: 需求2_

- [ ] 12. 实现房间等待界面
  - 创建房间内等待组件
  - 实现玩家列表和座位显示
  - 实现房主开始游戏控制
  - _需求: 需求3_

- [ ] 12.1 创建房间等待组件
  - 在frontend/src/components/room/中创建RoomWaiting组件
  - 实现4个座位的玩家信息显示
  - 实现房主的开始游戏按钮，人数不足时置灰
  - 实现玩家退出房间功能
  - 编写房间等待组件的单元测试
  - _需求: 需求3_

- [ ] 12.2 实现WebSocket房间通信
  - 在frontend/src/services/中创建WebSocket客户端
  - 实现房间状态的实时同步
  - 实现玩家加入/离开的实时通知
  - 实现连接断开的自动重连机制
  - 编写WebSocket通信的集成测试
  - _需求: 需求3, 需求4_

- [ ] 13. 实现游戏主界面
  - 创建游戏棋盘和手牌显示组件
  - 实现出牌区和玩家状态显示
  - 实现手牌选择和出牌操作
  - _需求: 需求6, 需求7_

- [ ] 13.1 创建游戏棋盘组件
  - 在frontend/src/components/game/中创建GameBoard组件
  - 实现4个玩家出牌区的布局（下方、左侧、上方、右侧）
  - 实现等级显示组件，显示两队当前等级和本局等级
  - 实现玩家状态显示（等待、出牌、已出牌、已过牌）
  - 编写游戏棋盘组件的单元测试
  - _需求: 需求6_

- [ ] 13.2 创建手牌管理组件
  - 创建PlayerHand组件，实现手牌的分组和排序显示
  - 实现手牌的点击选择功能，支持多选
  - 实现手牌按点数分组，按花色优先级纵向堆叠
  - 实现选中牌的视觉反馈
  - 编写手牌组件的单元测试
  - _需求: 需求6_

- [ ] 13.3 创建出牌控制组件
  - 创建GameControls组件，实现出牌和不出按钮
  - 实现出牌前的牌型验证和提示
  - 实现20秒倒计时显示
  - 实现轮到玩家时的操作提示
  - 编写出牌控制组件的单元测试
  - _需求: 需求7_

- [ ] 14. 实现上贡阶段界面
  - 创建上贡选择和显示组件
  - 实现贡池选择界面（双下情况）
  - 实现还贡过程的可视化
  - _需求: 需求5_

- [ ] 14.1 创建上贡阶段组件
  - 在frontend/src/components/game/中创建TributePhase组件
  - 实现上贡信息的显示（谁给谁上贡、免贡情况）
  - 实现双下情况的贡池选择界面，显示3秒选择倒计时
  - 实现还贡过程的动画显示
  - 编写上贡组件的单元测试
  - _需求: 需求5_

- [ ] 15. 实现Deal结算界面
  - 创建局结果显示组件
  - 实现排名和升级结果展示
  - 实现继续/退出操作选择
  - _需求: 需求8, 需求9_

- [ ] 15.1 创建Deal结算组件
  - 在frontend/src/components/game/中创建DealResult组件
  - 实现出完牌顺序的排名显示，按队伍分组
  - 实现胜利类型和升级结果的展示
  - 实现Deal统计信息显示（时长、出牌次数等）
  - 编写结算组件的单元测试
  - _需求: 需求8_

- [ ] 15.2 实现Match结束处理
  - 实现Match结束时的最终结果显示
  - 实现继续游戏和退出房间的操作按钮
  - 实现达到A级时的胜负结果展示
  - 编写Match结束的集成测试
  - _需求: 需求9_

- [ ] 16. 集成测试和优化
  - 进行完整游戏流程的端到端测试
  - 实现性能优化和错误处理完善
  - 实现部署配置和文档完善
  - _需求: 需求1-11_

- [ ] 16.1 端到端测试
  - 编写完整游戏流程的自动化测试
  - 测试多用户并发游戏场景
  - 测试断线重连和托管功能
  - 测试各种边界情况和错误处理
  - _需求: 需求1-11_

- [ ] 16.2 性能优化和部署
  - 优化WebSocket消息频率和大小
  - 实现游戏状态的增量更新
  - 完善Docker配置和部署文档
  - 实现监控和日志记录
  - _需求: 需求1-11_