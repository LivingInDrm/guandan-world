#掼蛋 Deal 的出牌阶段主循环
#目标：通过多个 Trick（墩）轮流出牌，直到某队两位玩家出完牌，终止该局

##出牌循环中的变量含义

| 变量名             | 类型         | 描述                      |
| --------------- | ---------- | ----------------------- |
| `activePlayers` | Set<Seat>  | 当前仍持有手牌的玩家集合            |
| `passSet`       | Set<Seat>  | 本 Trick 中选择 PASS 的玩家集合  |
| `tablePlay`     | Combo      | 当前桌面上的最大牌组，下一玩家需“同型且更大” |
| `lastWinner`    | Seat       | 本 Trick 中最后一次有效出牌者      |
| `rankList`      | List<Seat> | 玩家出完牌的顺序（用于结算、升级）       |
| `current`       | Seat       | 当前轮到操作的玩家               |


##出牌循环的伪代码

while activePlayers.count > 1:

    //----------------------------------------------------------------
    // ① Trick 初始化：选定本轮的首出玩家（Leader）
    //    - 每Deal的 第一 Trick Leader由外部规则决定（例如抽牌、进贡规则）
    //    - 后续 Trick 由上一 Trick 最后有效出牌者（lastWinner）担任
    //----------------------------------------------------------------
    leader ← lastWinner

    //----------------------------------------------------------------
    // ② Leader 出牌：可任意出一个合法牌型作为桌面牌（tablePlay）
    //    - playBy() 内部应完成合法性判断、从手牌中移除出牌
    //    - 桌面牌型 tablePlay 会被后续玩家用于“是否可压制”判断
    //----------------------------------------------------------------
    tablePlay ← playBy(leader)

    //----------------------------------------------------------------
    // ③ Leader 出完牌后，立即检查是否已出清 + 是否终结本局 Deal
    //    - 若出完，则记录名次并从 activePlayers 中移除
    //    - 若一整队出完，则补全剩余玩家名次并跳出整个出牌阶段
    //----------------------------------------------------------------
    lastWinner ← leader
    passSet ← ∅
    postPlayCheck(leader)  // 出牌后立即检查是否出完牌 + 是否终止 Deal
    current ← nextClockwise(leader)

    //----------------------------------------------------------------
    // ④ Trick 内出牌循环：从 Leader 顺时针开始轮流出牌或 PASS
    //    - 若手牌为空玩家则跳过
    //    - 若有玩家能压住桌面牌型，则其出牌，成为 lastWinner
    //    - 否则玩家 PASS，加入 passSet
    //    - 一轮内若出现 n-1 人 PASS，则 Trick 终止
    //----------------------------------------------------------------
    while true:

        // 跳过已出完手牌的玩家（如该玩家刚出清或此前已出清）
        while current not in activePlayers:
            current ← nextClockwise(current)

        // 若该玩家有能力压制桌面牌型，则执行出牌流程
        if canBeat(current, tablePlay):

            //----------------------------------------------------------------
            // 玩家出牌成功，更新桌面牌型并重置 PASS 状态
            // playBy() 应更新其手牌状态
            //----------------------------------------------------------------
            tablePlay ← playBy(current)
            lastWinner ← current
            passSet ← ∅

            postPlayCheck(current)      // 出牌后立即检查是否出完牌 + 是否终止 Deal


        else:
            //----------------------------------------------------------------
            // 玩家选择 PASS，表示不出牌，加入 passSet
            // 若本 Trick 中 n-1 人 PASS，则当前 Trick 终止
            //----------------------------------------------------------------
            passSet ← passSet ∪ {current}

        //----------------------------------------------------------------
        // Trick 结束条件：除一人外全部 PASS
        // 下一轮 Trick 将由 lastWinner 作为新的 Leader
        //----------------------------------------------------------------
        if passSet.count == activePlayers.count - 1:
            break  // 当前 Trick 终止，返回主循环，进入下一 Trick

        //----------------------------------------------------------------
        // 顺时针切换到下一个玩家，继续 Trick 出牌
        //----------------------------------------------------------------
        current ← nextClockwise(current)


function postPlayCheck(player):

    //----------------------------------------------------------------
    // ① 若该玩家手牌已全部出完，则记录名次并移出活跃玩家列表
    //----------------------------------------------------------------
    if handEmpty(player):
        rankList.append(player)           // 记录该玩家的出完顺序
        activePlayers.remove(player)      // 从活跃出牌者中移除

        //----------------------------------------------------------------
        // ①.1 若该玩家所在的队伍两人都出完牌，则本 Deal 应立即终止
        //      - 顺时针补全剩余玩家的名次
        //      - 退出最外层出牌循环，进入结算阶段
        //----------------------------------------------------------------
        if twoPlayersSameTeam(rankList):
            rankList.extend(clockwiseRemaining(player))
            break outer  // 跳出出牌主循环，结束本局 Deal

    //----------------------------------------------------------------
    // ② 若该玩家手牌数量小于等于 10 张，则变为“公开可见手牌数”状态
    //    - 系统可通过事件通知其他客户端刷新 UI 显示手牌数量
    //----------------------------------------------------------------
    if handCount(player) <= 10:
        revealHandCountToOthers(player)
